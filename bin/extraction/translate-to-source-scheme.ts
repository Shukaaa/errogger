import {ScanResult} from "./types/scan.js";
import {JsdocBlock} from "./types/jsdoc.js";
import path from "path";
import {LogUtils, SwerrConfig, SwerrScheme} from "@swerr/core";

export function translateToSourceScheme(scanResult: ScanResult, config: SwerrConfig | null): SwerrScheme {
    const name = config?.sourceFile?.meta?.projectName || "";
    const description = config?.sourceFile?.meta?.description ||`Generated by Swerr`;
    const version = config?.sourceFile?.meta?.version || "1.0.0";
    const errors = scanResult.blocks.map(block => {
        if (!block.tags.find((t:any) => t.name === "error")) {
            LogUtils.debug(`Skipping JSDocs block without @error tag in file: ${block.filePath}`);
            return
        }

        return {
            name: getErrorNameFromBlock(block),
            description: block.description,
            tags: block.tags.map((tag: any) => ({
                name: tag.name,
                description: tag.raw.trim()
            }))
        };
    });
    return {
        name,
        description,
        version,
        errors: errors.filter((e): e is Exclude<typeof e, undefined> => e !== undefined)
    };
}

function getErrorNameFromBlock(block: JsdocBlock): string {
    const errorTag = block.tags.find(tag => tag.name === "error");
    if (errorTag && errorTag.raw.trim().length > 0) {
        const parts = errorTag.raw.trim().split(/\s+/);
        return parts[0];
    }

    const fileName = path.basename(block.filePath);
    return fileName.replace(/\.[^/.]+$/, "");
}